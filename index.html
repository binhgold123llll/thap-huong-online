<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Th·∫Øp h∆∞∆°ng online</title>
  <style>
    :root{
      --bg1:#0b1020;
      --bg2:#111827;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --panel:#0b1220cc;
      --stroke:#ffffff22;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
      min-height:100vh;
      background:
        radial-gradient(900px 650px at 50% 0%, rgba(251,191,36,.14), transparent 58%),
        radial-gradient(900px 650px at 80% 20%, rgba(239,68,68,.10), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      overflow:hidden;
    }

    .topbar{
      position:fixed; left:0; right:0; top:0;
      padding:14px 16px;
      display:flex; align-items:center; justify-content:center;
      z-index:50;
      pointer-events:none;
    }
    .title{
      pointer-events:auto;
      display:flex; flex-direction:column; align-items:center; gap:4px;
      padding:10px 14px;
      border-radius:16px;
      background: rgba(0,0,0,.25);
      border: 1px solid var(--stroke);
      backdrop-filter: blur(10px);
    }
    .title h1{ margin:0; font-size:16px; letter-spacing:.2px; }
    .title .sub{ font-size:12px; color:var(--muted); }

    .stage{
      position:relative;
      width:min(980px, 96vw);
      margin: 76px auto 0;
      border-radius: 18px;
      overflow:hidden;
      box-shadow: 0 22px 60px rgba(0,0,0,.45);
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      aspect-ratio: 1 / 1;
    }
    .bg{
      position:absolute; inset:0;
      width:100%; height:100%;
      object-fit:cover;
      user-select:none;
      pointer-events:none;
      transform: translateZ(0);
    }

    canvas#smoke{
      position:absolute;
      inset:0;
      width:100%; height:100%;
      pointer-events:none;
      opacity:.95;
      z-index: 20;
    }

    .sticks{
      position:absolute;
      inset:0;
      z-index: 30;
      pointer-events:none;
    }
    .stick{
      position:absolute;
      width: 26px;
      height: 260px;
      transform-origin: 50% 95%;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.45));
      animation: rise .35s ease-out;
      transform: rotate(var(--rot));
    }
    @keyframes rise{
      from{ transform: translateY(28px) scale(.95) rotate(var(--rot)); opacity:0; }
      to{ transform: translateY(0) scale(1) rotate(var(--rot)); opacity:1; }
    }
    .stick:before{
      content:"";
      position:absolute;
      left:50%; transform:translateX(-50%);
      top: 30px;
      width: 10px;
      height: 210px;
      border-radius: 999px;
      background: linear-gradient(180deg, #fbbf24, #b45309);
      border: 1px solid rgba(0,0,0,.25);
    }
    .stick:after{
      content:"";
      position:absolute;
      left:50%; transform:translateX(-50%);
      top: 10px;
      width: 14px;
      height: 24px;
      border-radius: 999px;
      background: #ef4444;
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: 0 0 0 0 rgba(239,68,68,0);
      transition: box-shadow .25s ease;
    }
    .stick.on:after{ box-shadow: 0 0 16px 10px rgba(239,68,68,.16); }
    .stick .stem{
      position:absolute;
      left:50%; transform:translateX(-50%);
      bottom: 2px;
      width: 6px;
      height: 44px;
      border-radius: 999px;
      background: #3b2f2f;
      opacity:.9;
    }

    .controls{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom: 14px;
      display:flex;
      gap:10px;
      z-index: 60;
      flex-wrap:wrap;
      justify-content:center;
      padding: 0 12px;
    }
    .btn{
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:10px;
      padding: 10px 12px;
      border-radius: 16px;
      background: var(--panel);
      border: 1px solid var(--stroke);
      color: var(--text);
      backdrop-filter: blur(10px);
      box-shadow: 0 18px 50px rgba(0,0,0,.35);
      font-weight:900;
      user-select:none;
    }
    .btn:active{ transform: translateY(1px); }

    .hint{
      position:fixed;
      right: 12px;
      bottom: 12px;
      padding:10px 12px;
      border-radius: 16px;
      background: rgba(0,0,0,.22);
      border: 1px solid var(--stroke);
      color: var(--muted);
      font-size:12px;
      z-index: 60;
      max-width: 260px;
      backdrop-filter: blur(10px);
    }
    @media (max-width: 620px){ .hint{ display:none; } }

    .missing{
      position:absolute; inset:0;
      display:none;
      place-items:center;
      text-align:center;
      padding: 18px;
      color: var(--muted);
      z-index: 5;
      background: rgba(0,0,0,.35);
    }
    .missing b{ color: var(--text); }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="title">
      <h1>Th·∫Øp h∆∞∆°ng online</h1>
      <div class="sub">B·∫•m ‚ÄúTh·∫Øp h∆∞∆°ng‚Äù ƒë·ªÉ c·∫Øm nhang & kh√≥i bay (theo m·∫´u ·∫£nh)</div>
    </div>
  </div>

  <div class="stage" id="stage">
    <img class="bg" id="scene" alt="B√†n th·ªù" src="./scene.png?v=1">
    <div class="missing" id="missing">
      <div>
        <div style="font-size:18px;font-weight:900;margin-bottom:8px;">Ch∆∞a th·∫•y ·∫£nh n·ªÅn <b>scene.png</b></div>
        <div>H√£y upload ·∫£nh m·∫´u v√†o repo v√† ƒë·∫∑t t√™n <b>scene.png</b><br/>r·ªìi refresh l·∫°i trang.</div>
      </div>
    </div>

    <canvas id="smoke"></canvas>
    <div class="sticks" id="sticks"></div>
  </div>

  <div class="controls">
    <button class="btn" id="addIncense">üßß Th·∫Øp h∆∞∆°ng</button>
    <button class="btn" id="bow3">üôè L·∫°y 3 l·∫°y</button>
    <button class="btn" id="clear">üßπ D·ªçn b√†n</button>
  </div>

  <div class="hint">
    Tip: th·∫Øp t·ªëi ƒëa 9 n√©n.<br/>
    N·∫øu nhang ch∆∞a ƒë√∫ng t√¢m l∆∞ h∆∞∆°ng, ch·ªânh 2 s·ªë INCENSE_ANCHOR trong code l√† xong.
  </div>

<script>
  // ====== V·ªã tr√≠ "t√¢m l∆∞ h∆∞∆°ng" theo t·ªâ l·ªá (0..1) c·ªßa khung ·∫£nh ======
  const INCENSE_ANCHOR = { x: 0.53, y: 0.78 }; // ch·ªânh nh·∫π n·∫øu c·∫ßn
  const MAX = 9;

  const stage = document.getElementById("stage");
  const sticksEl = document.getElementById("sticks");
  const sceneImg = document.getElementById("scene");
  const missingEl = document.getElementById("missing");

  sceneImg.addEventListener("error", () => {
    missingEl.style.display = "grid";
  });

  let count = 0;
  function rnd(a,b){ return a + Math.random()*(b-a); }

  function addStick(){
    if(count >= MAX) return;
    count++;

    const stick = document.createElement("div");
    stick.className = "stick on";
    stick.style.setProperty("--rot", `${rnd(-9,9)}deg`);
    stick.appendChild(Object.assign(document.createElement("div"), { className: "stem" }));

    const rect = stage.getBoundingClientRect();
    const ax = rect.width * INCENSE_ANCHOR.x;
    const ay = rect.height * INCENSE_ANCHOR.y;

    const spread = 18;
    const offset = (count - 1) * spread - ((Math.min(count, MAX) - 1) * spread)/2;
    const x = ax + offset + rnd(-6,6);
    const y = ay + rnd(-2,2);

    stick.style.left = `${x}px`;
    stick.style.top = `${y - 250}px`; // 250 ~ chi·ªÅu cao nhang

    sticksEl.appendChild(stick);
    setTimeout(()=> stick.classList.remove("on"), 6500);
    startSmokeBoost();
  }

  function clearAll(){
    sticksEl.innerHTML = "";
    count = 0;
    puffs.length = 0;
  }

  let bowing = false;
  async function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
  async function bow3(){
    if(bowing) return;
    bowing = true;
    for(let i=0;i<3;i++){
      stage.animate(
        [{ transform:"translateY(0)" },{ transform:"translateY(10px)" },{ transform:"translateY(0)" }],
        { duration: 650, easing:"ease-in-out" }
      );
      await sleep(760);
    }
    bowing = false;
  }

  document.getElementById("addIncense").onclick = addStick;
  document.getElementById("clear").onclick = clearAll;
  document.getElementById("bow3").onclick = bow3;

  // ====== Smoke canvas ======
  const canvas = document.getElementById("smoke");
  const ctx = canvas.getContext("2d");
  let W=0, H=0;

  function resize(){
    const r = canvas.getBoundingClientRect();
    W = canvas.width = Math.floor(r.width * devicePixelRatio);
    H = canvas.height = Math.floor(r.height * devicePixelRatio);
  }
  window.addEventListener("resize", resize);

  const puffs = [];
  function addPuff(x, y){
    puffs.push({
      x, y,
      vx: (Math.random()-0.5) * 0.25,
      vy: -(0.40 + Math.random()*0.40),
      a: 0,
      life: 0,
      max: 180 + Math.random()*80,
      r: 12 + Math.random()*18
    });
  }

  let boost = 0;
  function startSmokeBoost(){ boost = 110; }

  function draw(){
    ctx.clearRect(0,0,W,H);
    ctx.save();
    ctx.globalCompositeOperation = "lighter";

    const ax = W * INCENSE_ANCHOR.x;
    const ay = H * INCENSE_ANCHOR.y;

    const sources = Math.max(1, count);

    for(let i=0;i<sources;i++){
      if(Math.random() < 0.12){
        const sx = ax + (i-(sources-1)/2)*18*devicePixelRatio + (Math.random()-0.5)*10*devicePixelRatio;
        const sy = ay*devicePixelRatio + (Math.random()-0.5)*6*devicePixelRatio;
        addPuff(sx, sy);
      }
    }

    if(boost > 0){
      boost--;
      for(let k=0;k<2;k++){
        const sx = ax + (Math.random()-0.5)*28*devicePixelRatio;
        const sy = ay*devicePixelRatio + (Math.random()-0.5)*10*devicePixelRatio;
        addPuff(sx, sy);
      }
    }

    for(let i=puffs.length-1;i>=0;i--){
      const p = puffs[i];
      p.life++;
      p.x += p.vx * devicePixelRatio;
      p.y += p.vy * devicePixelRatio;
      p.vx += (Math.random()-0.5) * 0.01;
      p.a = Math.min(0.22, p.life/60 * 0.22) * (1 - p.life/p.max);

      const rr = p.r * devicePixelRatio * (1 + p.life/230);
      const grad = ctx.createRadialGradient(p.x,p.y,0,p.x,p.y,rr);
      grad.addColorStop(0, `rgba(255,255,255,${p.a})`);
      grad.addColorStop(1, `rgba(255,255,255,0)`);
      ctx.fillStyle = grad;
      ctx.beginPath();
      ctx.arc(p.x,p.y,rr,0,Math.PI*2);
      ctx.fill();

      if(p.life > p.max) puffs.splice(i,1);
    }

    ctx.restore();
    requestAnimationFrame(draw);
  }

  resize();
  draw();
</script>
</body>
</html>
