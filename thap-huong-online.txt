<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Th·∫Øp h∆∞∆°ng online üïØÔ∏è</title>
  <style>
    :root{
      --bg1:#0b1020;
      --bg2:#111827;
      --gold:#fbbf24;
      --red:#ef4444;
      --ink:#e5e7eb;
      --muted:#9ca3af;
      --card: rgba(255,255,255,.06);
      --stroke: rgba(255,255,255,.10);
      --shadow: 0 20px 60px rgba(0,0,0,.45);
      --radius: 22px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color: var(--ink);
      min-height:100vh;
      background:
        radial-gradient(1000px 700px at 20% 0%, rgba(251,191,36,.12), transparent 55%),
        radial-gradient(900px 650px at 80% 10%, rgba(239,68,68,.10), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      overflow-x:hidden;
    }
    .wrap{max-width:1100px;margin:0 auto;padding:26px 16px 60px}
    .top{
      display:flex;gap:14px;align-items:center;justify-content:space-between;flex-wrap:wrap;
      margin-bottom:14px;
    }
    .brand{display:flex;gap:12px;align-items:center}
    .logo{
      width:46px;height:46px;border-radius:16px;
      background: linear-gradient(135deg, rgba(251,191,36,.95), rgba(239,68,68,.85));
      box-shadow: 0 18px 40px rgba(251,191,36,.18);
      display:grid;place-items:center;
      font-size:20px;
    }
    h1{margin:0;font-size:20px;line-height:1.1}
    .sub{margin:4px 0 0;color:var(--muted);font-size:13px}
    .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .pill{
      display:flex;gap:8px;align-items:center;
      background: rgba(255,255,255,.06);
      border:1px solid var(--stroke);
      border-radius:999px;
      padding:8px 12px;
      box-shadow: 0 14px 34px rgba(0,0,0,.22);
      font-size:13px;
      user-select:none;
    }
    .dot{width:10px;height:10px;border-radius:999px;background:#10b981;box-shadow:0 0 0 6px rgba(16,185,129,.18)}
    .btn{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      color: var(--ink);
      cursor:pointer;
      border-radius: 14px;
      padding: 10px 14px;
      box-shadow: 0 14px 34px rgba(0,0,0,.22);
      transition: transform .08s ease, opacity .08s ease;
      font-weight:650;
    }
    .btn:hover{ transform: translateY(-1px); }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      border:0;
      background: linear-gradient(135deg, rgba(251,191,36,.95), rgba(239,68,68,.90));
      color:#111827;
    }
    .btn:disabled{opacity:.55; cursor:not-allowed; transform:none;}
    .grid{
      display:grid;
      grid-template-columns: 1.25fr .75fr;
      gap: 14px;
      margin-top: 14px;
    }
    @media (max-width: 950px){ .grid{grid-template-columns:1fr;} }

    .card{
      background: var(--card);
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      padding: 16px;
    }
    .card h2{margin:0 0 10px;font-size:15px}

    /* altar */
    .altar{
      position:relative;
      border-radius: 26px;
      padding: 18px;
      min-height: 520px;
      background:
        radial-gradient(800px 500px at 50% 0%, rgba(251,191,36,.10), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border: 1px solid rgba(255,255,255,.10);
      overflow:hidden;
    }
    .frame{
      border: 1px solid rgba(251,191,36,.28);
      border-radius: 22px;
      padding: 14px;
      height: 100%;
      position:relative;
    }
    .title{
      text-align:center;
      font-weight:800;
      letter-spacing:.3px;
      color: rgba(251,191,36,.95);
      margin-top: 2px;
    }
    .line{height:1px;background:rgba(251,191,36,.22);margin:10px 0 14px}

    /* portrait + bow area */
    .portraitWrap{
      width: 220px;
      margin: 0 auto 10px;
      position:relative;
    }
    .portrait{
      width: 220px;
      height: 230px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      background:
        linear-gradient(135deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      display:grid;
      place-items:center;
      position:relative;
      overflow:hidden;
      transform-origin: center 60%;
    }
    .portrait .ph{
      text-align:center;
      color: var(--muted);
      font-size: 12px;
      padding: 0 12px;
      line-height:1.35;
    }

    /* bow animation */
    @keyframes bow {
      0%   { transform: translateY(0) rotate(0deg) scale(1); }
      35%  { transform: translateY(10px) rotate(-2deg) scale(0.98); }
      70%  { transform: translateY(18px) rotate(-3deg) scale(0.965); }
      100% { transform: translateY(0) rotate(0deg) scale(1); }
    }
    .bowing{ animation: bow .85s ease-in-out; }

    .nameplate{
      text-align:center;
      font-weight:800;
      font-size: 16px;
      margin-top: 6px;
    }
    .dates{
      text-align:center;
      color: var(--muted);
      font-size: 12px;
      margin-top: 4px;
    }

    /* offerings */
    .offerings{
      margin: 10px auto 0;
      max-width: 760px;
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
      align-items:stretch;
    }
    @media (max-width: 860px){ .offerings{ grid-template-columns:1fr; } }
    .offCard{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      border-radius: 18px;
      padding: 12px;
      display:flex;
      gap: 10px;
      align-items:center;
      justify-content:space-between;
    }
    .offLeft{
      display:flex; gap:10px; align-items:center;
      min-width: 0;
    }
    .offIcon{
      width:44px;height:44px;border-radius:14px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      display:grid; place-items:center;
      font-size: 20px;
      box-shadow: 0 12px 24px rgba(0,0,0,.25);
      flex:0 0 auto;
    }
    .offText{
      min-width:0;
    }
    .offTitle{font-weight:850; font-size: 13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .offDesc{color:var(--muted); font-size: 12px; margin-top:3px; line-height:1.25;}
    .offBtn{
      border:1px solid rgba(251,191,36,.25);
      background: rgba(251,191,36,.08);
      color: var(--ink);
      padding: 9px 12px;
      border-radius: 14px;
      cursor:pointer;
      font-weight:750;
      transition: transform .08s ease;
      flex:0 0 auto;
    }
    .offBtn:hover{ transform: translateY(-1px); }
    .offBtn.on{
      border-color: rgba(16,185,129,.35);
      background: rgba(16,185,129,.12);
    }

    /* prayer inputs */
    .offer{
      margin: 12px auto 0;
      max-width: 760px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 560px){ .offer{ grid-template-columns: 1fr; } }
    .input, textarea{
      width:100%;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(17,24,39,.35);
      color: var(--ink);
      padding: 10px 12px;
      outline:none;
      font-size: 14px;
    }
    textarea{ grid-column: 1 / -1; min-height: 92px; resize: vertical; }
    .input:focus, textarea:focus{
      border-color: rgba(251,191,36,.5);
      box-shadow: 0 0 0 6px rgba(251,191,36,.12);
    }

    .actions{
      display:flex; gap:10px; flex-wrap:wrap; margin-top: 12px;
      justify-content:center;
    }
    .hint{
      text-align:center; color:var(--muted); font-size:12px; margin-top:10px;
    }

    /* incense */
    .incenseArea{
      position:absolute;
      left:0; right:0;
      bottom: 22px;
      height: 200px;
      display:flex;
      align-items:flex-end;
      justify-content:center;
      gap: 22px;
      pointer-events:none;
    }
    .stick{
      width: 22px;
      height: 160px;
      position:relative;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.35));
    }
    .stick .body{
      position:absolute; left:50%; transform:translateX(-50%);
      bottom: 0;
      width: 8px;
      height: 120px;
      border-radius: 10px;
      background: linear-gradient(180deg, #f97316, #b45309);
      border:1px solid rgba(0,0,0,.2);
    }
    .stick .tip{
      position:absolute; left:50%; transform:translateX(-50%);
      bottom: 120px;
      width: 10px;
      height: 16px;
      border-radius: 10px;
      background: #3f3f46;
      border:1px solid rgba(255,255,255,.08);
    }
    .stick .glow{
      position:absolute; left:50%; transform:translateX(-50%);
      bottom: 134px;
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: rgba(239,68,68,.0);
      box-shadow: 0 0 0 0 rgba(239,68,68,.0);
      transition: all .25s ease;
    }
    .stick.on .glow{
      background: rgba(239,68,68,.9);
      box-shadow: 0 0 14px 10px rgba(239,68,68,.18);
    }
    .ash{
      position:absolute;
      left:50%; transform:translateX(-50%);
      bottom: -6px;
      width: 140px; height: 28px;
      border-radius: 999px;
      background: rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.08);
      filter: blur(.2px);
    }

    /* smoke canvas */
    canvas#smoke{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      pointer-events:none;
      opacity:.9;
    }

    /* log */
    .log{
      height: 360px;
      overflow:auto;
      padding-right: 6px;
    }
    .entry{
      padding: 10px 12px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      margin: 10px 0;
      line-height: 1.35;
      font-size: 14px;
      white-space: pre-wrap;
    }
    .time{ color: var(--muted); font-size:12px; margin-top:6px; }

    .small{
      color: var(--muted);
      font-size: 12px;
      line-height:1.35;
    }

    /* toast */
    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: rgba(0,0,0,.55);
      border: 1px solid rgba(255,255,255,.12);
      padding: 10px 12px;
      border-radius: 14px;
      box-shadow: 0 18px 40px rgba(0,0,0,.35);
      color: var(--ink);
      font-size: 13px;
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
    }
    .toast.show{ opacity:1; transform: translateX(-50%) translateY(-4px); }
    .linkBox{
      margin-top: 10px;
      display:flex; gap:10px; flex-wrap:wrap;
    }
    .mini{
      padding: 8px 10px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color: var(--ink);
      cursor:pointer;
      font-weight:700;
      font-size: 13px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo">üïØÔ∏è</div>
        <div>
          <h1>Th·∫Øp h∆∞∆°ng online</h1>
          <div class="sub">B√†n th·ªù ·∫£o: th·∫Øp nhang + kh√≥i + ƒë·ªì l·ªÖ + l·∫°y 3 l·∫°y + l∆∞u l·ªùi kh·∫•n (ch·ªâ l∆∞u tr√™n m√°y b·∫°n)</div>
        </div>
      </div>
      <div class="toolbar">
        <div class="pill"><span class="dot"></span> trang ho·∫°t ƒë·ªông</div>
        <button class="btn" id="toggleSound">üîà Chu√¥ng: T·∫ÆT</button>
        <button class="btn primary" id="lightAll">üî• Th·∫Øp 3 n√©n</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>üïäÔ∏è Kh√¥ng gian th·∫Øp h∆∞∆°ng</h2>

        <div class="altar" id="altar">
          <canvas id="smoke"></canvas>

          <div class="frame">
            <div class="title">NAM M√î A DI ƒê√Ä PH·∫¨T</div>
            <div class="line"></div>

            <div class="portraitWrap">
              <div class="portrait" id="portrait">
                <div class="ph">
                  (B·∫°n c√≥ th·ªÉ ƒë·ªÉ tr·ªëng)<br/>
                  *M√¥ ph·ªèng t∆∞·ªüng nh·ªõ ‚Äî kh√¥ng thay th·∫ø nghi l·ªÖ ngo√†i ƒë·ªùi.*
                </div>
              </div>
            </div>

            <div class="nameplate" id="displayName">Gia ti√™n / Ng∆∞·ªùi ƒë√£ khu·∫•t</div>
            <div class="dates" id="displayDates">‚Äî</div>

            <!-- Offerings -->
            <div class="offerings">
              <div class="offCard">
                <div class="offLeft">
                  <div class="offIcon">üå∏</div>
                  <div class="offText">
                    <div class="offTitle">D√¢ng hoa</div>
                    <div class="offDesc">T·ªè l√≤ng hi·∫øu k√≠nh, thanh t·ªãnh.</div>
                  </div>
                </div>
                <button class="offBtn" id="btnFlower">D√¢ng</button>
              </div>

              <div class="offCard">
                <div class="offLeft">
                  <div class="offIcon">üçé</div>
                  <div class="offText">
                    <div class="offTitle">D√¢ng qu·∫£</div>
                    <div class="offDesc">C·∫ßu b√¨nh an, ƒë·ªß ƒë·∫ßy.</div>
                  </div>
                </div>
                <button class="offBtn" id="btnFruit">D√¢ng</button>
              </div>

              <div class="offCard">
                <div class="offLeft">
                  <div class="offIcon">üïØÔ∏è</div>
                  <div class="offText">
                    <div class="offTitle">Th·∫Øp n·∫øn</div>
                    <div class="offDesc">√Ånh s√°ng d·∫´n ƒë∆∞·ªùng, ·∫•m l√≤ng.</div>
                  </div>
                </div>
                <button class="offBtn" id="btnCandle">Th·∫Øp</button>
              </div>
            </div>

            <!-- Prayer -->
            <div class="offer">
              <input class="input" id="who" type="text" placeholder="T√™n ng∆∞·ªùi t∆∞·ªüng nh·ªõ (VD: √îng/B√†‚Ä¶)" />
              <input class="input" id="dates" type="text" placeholder="Ng√†y sinh - m·∫•t (VD: 1930‚Äì2015)" />
              <textarea id="prayer" placeholder="Ghi l·ªùi kh·∫•n / l·ªùi nh·∫Øn (VD: Con xin c·∫ßu b√¨nh an cho gia ƒë√¨nh‚Ä¶)"></textarea>
            </div>

            <div class="actions">
              <button class="btn" id="light1">Th·∫Øp 1 n√©n</button>
              <button class="btn" id="light2">Th·∫Øp 2 n√©n</button>
              <button class="btn" id="light3">Th·∫Øp 3 n√©n</button>

              <button class="btn primary" id="bow3">üôè L·∫°y 3 l·∫°y</button>

              <button class="btn" id="save">üíæ L∆∞u l·ªùi kh·∫•n</button>
              <button class="btn" id="clear">üßπ Xo√°</button>
            </div>

            <div class="hint">
              B·∫•m ‚ÄúTh·∫Øp‚Äù ƒë·ªÉ nhang s√°ng & kh√≥i bay ~ 60 gi√¢y.
              ‚ÄúL·∫°y 3 l·∫°y‚Äù s·∫Ω c√∫i 3 l·∫ßn.
              ‚ÄúL∆∞u‚Äù ch·ªâ l∆∞u trong tr√¨nh duy·ªát c·ªßa b·∫°n.
            </div>

            <div class="incenseArea" aria-hidden="true">
              <div class="stick" id="s1"><div class="glow"></div><div class="tip"></div><div class="body"></div></div>
              <div class="stick" id="s2"><div class="glow"></div><div class="tip"></div><div class="body"></div></div>
              <div class="stick" id="s3"><div class="glow"></div><div class="tip"></div><div class="body"></div></div>
              <div class="ash"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>üìú Nh·∫≠t k√Ω</h2>
        <div class="small">Ghi l·∫°i thao t√°c (l∆∞u trong tr√¨nh duy·ªát). B·∫°n c√≥ th·ªÉ copy n·ªôi dung ƒë·ªÉ g·ª≠i ng∆∞·ªùi th√¢n.</div>

        <div class="linkBox">
          <button class="mini" id="copyLog">üìã Copy nh·∫≠t k√Ω</button>
          <button class="mini" id="copyPrayer">üìã Copy l·ªùi kh·∫•n</button>
        </div>

        <div class="log" id="log"></div>

        <div class="small" style="margin-top:10px;">
          Mu·ªën chia s·∫ª th√†nh <b>link</b> th·∫≠t? Xem h∆∞·ªõng d·∫´n b√™n d∆∞·ªõi (m√¨nh ghi chi ti·∫øt ngay d∆∞·ªõi code).
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">ƒê√£ copy ‚úÖ</div>

<script>
  // ===== basic utils =====
  const $ = (id) => document.getElementById(id);
  const logEl = $("log");
  const sticks = [$("s1"), $("s2"), $("s3")];

  function timeNow(){
    const d = new Date();
    return d.toLocaleString("vi-VN", { hour:"2-digit", minute:"2-digit", day:"2-digit", month:"2-digit", year:"numeric" });
  }

  function escapeHtml(s){
    return (s || "").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  function addLog(text){
    const div = document.createElement("div");
    div.className = "entry";
    div.innerHTML = `${escapeHtml(text)}<div class="time">${timeNow()}</div>`;
    logEl.prepend(div);
    saveLogToStorage();
  }

  function toast(msg="ƒê√£ xong ‚úÖ"){
    const t = $("toast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 1100);
  }

  function updateDisplay(){
    const who = ($("who").value || "").trim();
    const dates = ($("dates").value || "").trim();
    $("displayName").textContent = who || "Gia ti√™n / Ng∆∞·ªùi ƒë√£ khu·∫•t";
    $("displayDates").textContent = dates || "‚Äî";
  }

  // ===== storage =====
  const KEY = "thap_huong_online_v2";
  const LOGKEY = "thap_huong_online_log_v2";
  const OFFERKEY = "thap_huong_online_offerings_v2";

  function saveForm(){
    const data = {
      who: $("who").value || "",
      dates: $("dates").value || "",
      prayer: $("prayer").value || ""
    };
    localStorage.setItem(KEY, JSON.stringify(data));
  }

  function loadForm(){
    try{
      const raw = localStorage.getItem(KEY);
      if(!raw) return;
      const data = JSON.parse(raw);
      $("who").value = data.who || "";
      $("dates").value = data.dates || "";
      $("prayer").value = data.prayer || "";
      updateDisplay();
    }catch(e){}
  }

  function saveLogToStorage(){
    localStorage.setItem(LOGKEY, logEl.innerHTML);
  }

  function loadLog(){
    const raw = localStorage.getItem(LOGKEY);
    if(raw) logEl.innerHTML = raw;
  }

  // ===== offerings toggle =====
  const offeringState = { flower:false, fruit:false, candle:false };

  function saveOfferings(){
    localStorage.setItem(OFFERKEY, JSON.stringify(offeringState));
  }
  function loadOfferings(){
    try{
      const raw = localStorage.getItem(OFFERKEY);
      if(!raw) return;
      const st = JSON.parse(raw);
      offeringState.flower = !!st.flower;
      offeringState.fruit  = !!st.fruit;
      offeringState.candle = !!st.candle;
      syncOfferingsUI();
    }catch(e){}
  }
  function syncOfferingsUI(){
    $("btnFlower").classList.toggle("on", offeringState.flower);
    $("btnFruit").classList.toggle("on", offeringState.fruit);
    $("btnCandle").classList.toggle("on", offeringState.candle);

    $("btnFlower").textContent = offeringState.flower ? "ƒê√£ d√¢ng" : "D√¢ng";
    $("btnFruit").textContent  = offeringState.fruit  ? "ƒê√£ d√¢ng" : "D√¢ng";
    $("btnCandle").textContent = offeringState.candle ? "ƒêang th·∫Øp" : "Th·∫Øp";
  }

  $("btnFlower").onclick = ()=>{
    offeringState.flower = !offeringState.flower;
    syncOfferingsUI();
    saveOfferings();
    addLog(offeringState.flower ? "ƒê√£ d√¢ng hoa üå∏." : "ƒê√£ h·∫° l·ªÖ hoa üå∏ (m√¥ ph·ªèng).");
    bell();
  };

  $("btnFruit").onclick = ()=>{
    offeringState.fruit = !offeringState.fruit;
    syncOfferingsUI();
    saveOfferings();
    addLog(offeringState.fruit ? "ƒê√£ d√¢ng qu·∫£ üçé." : "ƒê√£ h·∫° l·ªÖ qu·∫£ üçé (m√¥ ph·ªèng).");
    bell();
  };

  $("btnCandle").onclick = ()=>{
    offeringState.candle = !offeringState.candle;
    syncOfferingsUI();
    saveOfferings();
    addLog(offeringState.candle ? "ƒê√£ th·∫Øp n·∫øn üïØÔ∏è." : "ƒê√£ t·∫Øt n·∫øn üïØÔ∏è (m√¥ ph·ªèng).");
    bell();
  };

  // ===== sound: simple bell =====
  let soundOn = false;
  let audioCtx = null;

  function bell(){
    if(!soundOn) return;
    try{
      audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = "sine";
      o.frequency.value = 784;
      g.gain.value = 0.0001;
      o.connect(g).connect(audioCtx.destination);
      o.start();

      const t = audioCtx.currentTime;
      g.gain.setValueAtTime(0.0001, t);
      g.gain.exponentialRampToValueAtTime(0.08, t + 0.02);
      g.gain.exponentialRampToValueAtTime(0.0001, t + 0.9);
      o.frequency.exponentialRampToValueAtTime(392, t + 0.9);
      o.stop(t + 0.92);
    }catch(e){}
  }

  $("toggleSound").onclick = () => {
    soundOn = !soundOn;
    $("toggleSound").textContent = soundOn ? "üîî Chu√¥ng: B·∫¨T" : "üîà Chu√¥ng: T·∫ÆT";
    if(soundOn) bell();
  };

  // ===== smoke animation =====
  const canvas = $("smoke");
  const ctx = canvas.getContext("2d");
  let W = 0, H = 0;

  function resize(){
    const r = canvas.getBoundingClientRect();
    W = canvas.width = Math.floor(r.width * devicePixelRatio);
    H = canvas.height = Math.floor(r.height * devicePixelRatio);
  }
  window.addEventListener("resize", resize);

  const puffs = [];
  function addPuff(x, y){
    puffs.push({
      x, y,
      vx: (Math.random() - 0.5) * 0.25,
      vy: - (0.35 + Math.random()*0.35),
      a: 0.0,
      life: 0,
      max: 180 + Math.random()*80,
      r: 12 + Math.random()*18
    });
  }

  function draw(){
    ctx.clearRect(0,0,W,H);
    ctx.save();
    ctx.globalCompositeOperation = "lighter";

    for(let i=puffs.length-1;i>=0;i--){
      const p = puffs[i];
      p.life++;
      p.x += p.vx * devicePixelRatio;
      p.y += p.vy * devicePixelRatio;
      p.vx += (Math.random()-0.5) * 0.01;
      p.a = Math.min(0.20, p.life/60 * 0.20) * (1 - p.life/p.max);

      const rr = p.r * devicePixelRatio * (1 + p.life/220);
      const grad = ctx.createRadialGradient(p.x, p.y, 0, p.x, p.y, rr);
      grad.addColorStop(0, `rgba(255,255,255,${p.a})`);
      grad.addColorStop(1, `rgba(255,255,255,0)`);
      ctx.fillStyle = grad;
      ctx.beginPath();
      ctx.arc(p.x, p.y, rr, 0, Math.PI*2);
      ctx.fill();

      if(p.life > p.max) puffs.splice(i,1);
    }
    ctx.restore();
    requestAnimationFrame(draw);
  }

  // ===== lighting logic =====
  let burnTimer = null;

  function sticksOn(n){
    sticks.forEach((s, idx) => s.classList.toggle("on", idx < n));
  }

  function startBurn(n){
    sticksOn(n);
    bell();

    const altarRect = $("altar").getBoundingClientRect();
    const tips = [$("s1"), $("s2"), $("s3")].slice(0, n).map(el => el.getBoundingClientRect());

    let burnLeft = 60;
    if(burnTimer) clearInterval(burnTimer);

    addLog(`ƒê√£ th·∫Øp ${n} n√©n h∆∞∆°ng.`);
    burnTimer = setInterval(()=>{
      burnLeft--;

      tips.forEach(r=>{
        const x = (r.left + r.width/2 - altarRect.left) * devicePixelRatio;
        const y = (r.top + 18 - altarRect.top) * devicePixelRatio;
        for(let k=0;k<2;k++) addPuff(x + (Math.random()-0.5)*14*devicePixelRatio, y + (Math.random()-0.5)*6*devicePixelRatio);
      });

      if(burnLeft <= 0){
        clearInterval(burnTimer);
        burnTimer = null;
        sticksOn(0);
        addLog("H∆∞∆°ng ƒë√£ t√†n (k·∫øt th√∫c m√¥ ph·ªèng).");
      }
    }, 1000);
  }

  $("light1").onclick = ()=> startBurn(1);
  $("light2").onclick = ()=> startBurn(2);
  $("light3").onclick = ()=> startBurn(3);
  $("lightAll").onclick = ()=> startBurn(3);

  // ===== bow 3 times =====
  function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }

  async function bowThree(){
    const btn = $("bow3");
    btn.disabled = true;
    addLog("ƒêang l·∫°y 3 l·∫°y üôè");
    bell();

    const p = $("portrait");
    for(let i=1;i<=3;i++){
      p.classList.remove("bowing");
      void p.offsetWidth; // restart animation
      p.classList.add("bowing");
      addLog(`L·∫°y ${i}/3`);
      await sleep(900);
    }
    addLog("ƒê√£ l·∫°y xong 3 l·∫°y üôè");
    btn.disabled = false;
  }
  $("bow3").onclick = bowThree;

  // ===== save/clear =====
  $("save").onclick = ()=>{
    saveForm();
    updateDisplay();
    const who = ($("who").value || "").trim() || "Gia ti√™n / Ng∆∞·ªùi ƒë√£ khu·∫•t";
    const prayer = ($("prayer").value || "").trim();
    addLog(`ƒê√£ l∆∞u l·ªùi kh·∫•n cho: ${who}.\n${prayer ? "L·ªùi kh·∫•n: " + prayer : "(Kh√¥ng c√≥ n·ªôi dung l·ªùi kh·∫•n)"}\n`);
    bell();
    toast("ƒê√£ l∆∞u ‚úÖ");
  };

  $("clear").onclick = ()=>{
    $("who").value = "";
    $("dates").value = "";
    $("prayer").value = "";
    updateDisplay();
    saveForm();

    // reset offerings (optional: gi·ªØ l·∫°i c≈©ng ƒë∆∞·ª£c; m√¨nh reset cho s·∫°ch)
    offeringState.flower=false; offeringState.fruit=false; offeringState.candle=false;
    syncOfferingsUI(); saveOfferings();

    addLog("ƒê√£ xo√° n·ªôi dung & ƒë·ªì l·ªÖ (m√¥ ph·ªèng).");
    toast("ƒê√£ xo√° ‚úÖ");
  };

  ["who","dates","prayer"].forEach(id=>{
    $(id).addEventListener("input", ()=>{
      updateDisplay();
      saveForm();
    });
  });

  // ===== copy helpers =====
  async function copyText(text){
    try{
      await navigator.clipboard.writeText(text);
      toast("ƒê√£ copy ‚úÖ");
    }catch(e){
      // fallback
      const ta = document.createElement("textarea");
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      ta.remove();
      toast("ƒê√£ copy ‚úÖ");
    }
  }

  $("copyLog").onclick = ()=>{
    const temp = document.createElement("div");
    temp.innerHTML = logEl.innerHTML;
    const entries = [...temp.querySelectorAll(".entry")].map(e=>{
      const time = e.querySelector(".time")?.textContent || "";
      e.querySelector(".time")?.remove();
      const text = e.textContent.trim();
      return `${text}\n${time}`.trim();
    });
    copyText(entries.reverse().join("\n\n---\n\n"));
  };

  $("copyPrayer").onclick = ()=>{
    const who = ($("who").value || "").trim() || "Gia ti√™n / Ng∆∞·ªùi ƒë√£ khu·∫•t";
    const dates = ($("dates").value || "").trim();
    const prayer = ($("prayer").value || "").trim() || "(Kh√¥ng c√≥ n·ªôi dung)";
    copyText(`TH·∫ÆP H∆Ø∆†NG ONLINE\nƒê·ªëi t∆∞·ª£ng: ${who}${dates ? " ("+dates+")" : ""}\n\nL·ªùi kh·∫•n:\n${prayer}`);
  };

  // init
  function init(){
    loadForm();
    loadOfferings();
    loadLog();
    resize();
    draw();
    addLog("M·ªü trang th·∫Øp h∆∞∆°ng online (v2).");
    updateDisplay();
    syncOfferingsUI();
  }
  init();
</script>
</body>
</html>
